---
import Layout from '../layouts/Layout.astro';
import Card from '../components/Card.astro';
import TechBadge from '../components/TechBadge.astro';
import { getPortfolioData } from '../lib/api';

Astro.response.headers.set('Cache-Control', 'public, max-age=300, s-maxage=300');

const { projects, skills, isOffline, error } = await getPortfolioData();
---

<Layout title="Manpreet | Systems Engineer">
  <main class="max-w-6xl mx-auto p-4 md:p-8 pt-12 md:pt-24 animate-fade-in">
    
    <header class="mb-12 md:mb-20">
      <div class="flex items-center gap-3 mb-6">
        <div class={`w-1.5 h-1.5 rounded-sm ${isOffline ? 'bg-red-500' : 'bg-emerald-500'} animate-pulse`}></div>
        <span id="status-text" class="text-xs font-mono tracking-widest text-text-muted">
          SYSTEM STATUS: {isOffline ? 'OFFLINE' : 'OPERATIONAL'}
        </span>
      </div>
      <h1 class="text-5xl md:text-8xl font-bold tracking-tighter text-text-main mb-6">
        Manpreet.
      </h1>
      <p class="text-xl md:text-2xl text-text-muted max-w-2xl leading-relaxed">
        Building robust infrastructure.
        <span class="block text-text-main mt-2">Focused on Rust, Distributed Systems, and Platform Engineering.</span>
      </p>
    </header>

    {isOffline && (
      <div class="mb-12 p-4 border-l-2 border-red-500 bg-red-500/5 text-red-400 text-xs font-mono flex items-start gap-3 rounded-r-md">
        <span class="mt-0.5">⚠️</span>
        <div>
          <p class="font-bold">[FATAL] Backend Connection Failed</p>
          <p class="opacity-80 mt-1">Error: {error || "Connection Refused (os error 111)"}</p>
          <p class="opacity-60 mt-2">> Serving static fallback content...</p>
        </div>
      </div>
    )}

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 auto-rows-auto md:auto-rows-[280px]">

      <Card colSpan="md:col-span-2" class="min-h-[280px]">
        <div>
          <h2 class="text-xs font-mono text-text-muted mb-2 tracking-widest">01 // PHILOSOPHY</h2>
          <p class="text-xl text-text-main font-medium tracking-tight">
            "Software should be boring."
          </p>
        </div>
        <div class="mt-auto pt-8 md:pt-0">
          <p class="text-text-muted leading-relaxed text-sm">
            I value predictability over flashiness. My work involves designing systems that are type-safe, observable, and easy to maintain.
          </p>
        </div>
      </Card>

      <Card rowSpan="md:row-span-2" class="min-h-[280px]">
        <h2 class="text-xs font-mono text-text-muted mb-6 tracking-widest">02 // ARSENAL</h2>
        
        {skills.length > 0 ? (() => {
          const core = skills.filter(s => ['Rust', 'NextJS', 'React', 'Tauri', 'C++', 'Go'].includes(s.name));
          const infra = skills.filter(s => ['CF Workers', 'D1', 'Docker', 'Terraform', 'Postgres', 'Redis', 'gRPC'].includes(s.name));
          const env = skills.filter(s => ['Arch', 'Neovim', 'Git', 'Linux', 'Linux / Arch'].includes(s.name));
          const other = skills.filter(s => !core.includes(s) && !infra.includes(s) && !env.includes(s));
          
          return (
            <div class="space-y-6">
              {core.length > 0 && (
                <div>
                  <span class="text-[10px] font-mono text-text-muted uppercase mb-3 block tracking-widest">[ CORE STACK ]</span>
                  <div class="flex flex-wrap gap-2">
                    {core.map(skill => <TechBadge label={skill.name} />)}
                  </div>
                </div>
              )}
              {infra.length > 0 && (
                <div class={core.length > 0 ? "mt-6" : ""}>
                  <span class="text-[10px] font-mono text-text-muted uppercase mb-3 block tracking-widest">[ INFRA & DATA ]</span>
                  <div class="flex flex-wrap gap-2">
                    {infra.map(skill => <TechBadge label={skill.name} />)}
                  </div>
                </div>
              )}
              {env.length > 0 && (
                <div class={(core.length > 0 || infra.length > 0) ? "mt-6" : ""}>
                  <span class="text-[10px] font-mono text-text-muted uppercase mb-3 block tracking-widest">[ ENVIRONMENT ]</span>
                  <div class="flex flex-wrap gap-2">
                    {env.map(skill => <TechBadge label={skill.name} />)}
                  </div>
                </div>
              )}
              {other.length > 0 && (
                <div class="mt-auto pt-8 flex flex-wrap gap-2">
                    {other.map(skill => <TechBadge label={skill.name} />)}
                </div>
              )}
            </div>
          );
        })() : (
          /* Fallback if API fails or returns empty */
          <div class="space-y-6">
            <div>
              <span class="text-[10px] font-mono text-text-muted uppercase mb-3 block tracking-widest">[ CORE STACK ]</span>
              <div class="flex flex-wrap gap-2">
                <TechBadge label="Rust" />
                <TechBadge label="React" />
                <TechBadge label="Tauri" />
              </div>
            </div>
            <div class="mt-6">
              <span class="text-[10px] font-mono text-text-muted uppercase mb-3 block tracking-widest">[ INFRA & DATA ]</span>
              <div class="flex flex-wrap gap-2">
                <TechBadge label="CF Workers" />
                <TechBadge label="D1" />
                <TechBadge label="Docker" />
              </div>
            </div>
            <div class="mt-6">
              <span class="text-[10px] font-mono text-text-muted uppercase mb-3 block tracking-widest">[ ENVIRONMENT ]</span>
              <div class="flex flex-wrap gap-2">
                <TechBadge label="Arch" />
                <TechBadge label="Neovim" />
                <TechBadge label="Git" />
              </div>
            </div>
            <div class="mt-auto pt-8 flex flex-wrap gap-2">
                <TechBadge label="Rust" />
                <TechBadge label="Linux / Arch" />
                <TechBadge label="Git Internals" />
                <TechBadge label="Tokio" />
            </div>
          </div>
        )}
      </Card>

      <Card class="min-h-[280px]">
        <div class="flex justify-between items-start">
            <h2 class="text-xs font-mono text-text-muted tracking-widest">03 // FEATURED</h2>
            <div class="w-1.5 h-1.5 rounded-full bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
        </div>
        <div class="mt-auto pt-8 md:pt-0">
          <h3 class="text-2xl text-text-main font-medium mb-1">ax</h3>
          <p class="text-xs text-text-muted mb-4 font-mono">An AUR helper and Pacman wrapper written in Rust streamlining package management on Arch Linux systems by seamlessly integrating official repository packages and the Arch User Repository (AUR)</p>
          <div class="flex gap-2">
            <TechBadge label="Rust" />
            <TechBadge label="alpm" />
            <TechBadge label="git2" />
            <TechBadge label="Linux" />
          </div>
        </div>
      </Card>

      <Card colSpan="md:col-span-2" class="min-h-[280px] group/card cursor-pointer relative" onclick="window.location.href='/projects'">
        <div class="flex justify-between items-start mb-6">
            <h2 class="text-xs font-mono text-text-muted tracking-widest">04 // SELECTED WORK</h2>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-text-main group-hover/card:-translate-y-1 group-hover/card:translate-x-1 transition-transform"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>
        </div>
        
        <div class="mt-auto pt-4 md:pt-0 flex flex-col h-full justify-end pb-2">
            
            {projects.length > 0 ? (
              <div class="relative overflow-hidden w-full h-[120px]">
                {/* Simulated Carousel of Projects - showing the first one mainly, or mapping through all gracefully fading */}
                {projects.slice(0, 5).map((project: any, index: number) => (
                  <div class={`absolute inset-0 transition-opacity duration-500 flex flex-col justify-end ${index === 0 ? 'opacity-100 z-10' : 'opacity-0 z-0'}`} style={`animation: carousel ${projects.slice(0, 5).length * 4}s infinite; animation-delay: ${index * 4}s;`}>
                    <h3 class="text-xl text-text-main font-medium mb-2 truncate">
                      {project.title}
                    </h3>
                    <p class="text-sm text-text-muted max-w-sm mb-6 line-clamp-2">
                      {project.description}
                    </p>
                  </div>
                ))}
              </div>
            ) : (
              <div>
                <h3 class="text-xl text-text-main font-medium mb-2">Projects Offline</h3>
                <p class="text-sm text-text-muted max-w-sm mb-6">Unable to load dynamic projects from Edge API.</p>
              </div>
            )}
            
            {projects.length > 0 && (
              <div class="flex items-center gap-2 max-w-xs mt-4">
                {projects.slice(0, 5).map((_: any, idx: number) => (
                  <div class="h-1 bg-white/10 flex-1 rounded-full overflow-hidden relative">
                     <div class="absolute inset-y-0 left-0 bg-text-main opacity-0 w-full" style={`animation: progress ${projects.slice(0, 5).length * 4}s infinite; animation-delay: ${idx * 4}s;`}></div>
                     {/* For a static fallback, just highlight the first one */}
                     {idx === 0 && <div class="absolute inset-y-0 left-0 bg-text-main/50 w-full hidden"></div>}
                  </div>
                ))}
              </div>
            )}
            
            <style>
              @keyframes carousel {
                0%, 15% { opacity: 1; z-index: 10; }
                20%, 100% { opacity: 0; z-index: 0; }
              }
              @keyframes progress {
                0% { width: 0%; opacity: 1; }
                15% { width: 100%; opacity: 1; }
                15.1%, 100% { width: 100%; opacity: 0; }
              }
            </style>
        </div>
      </Card>

      <Card class="bg-surface text-text-main hover:bg-surface-hover min-h-[160px] md:min-h-[280px]">
        <h2 class="text-xs font-mono text-text-muted tracking-widest">05 // SOURCE</h2>
        <div class="mt-auto pt-8 md:pt-0">
          <a href="https://github.com/manpreet113" target="_blank" class="block group-hover:translate-x-1 transition-transform">
            <h3 class="text-3xl font-bold tracking-tighter">GitHub ↗</h3>
            <p class="text-xs text-text-muted mt-2 font-mono">github.com/manpreet113</p>
          </a>
        </div>
      </Card>

    </div>

    <footer class="mt-24 border-t border-border pt-8 flex flex-col md:flex-row justify-between items-start md:items-center text-xs text-text-muted font-mono">
      <div class="mb-4 md:mb-0">
        <span class="block text-text-main mb-1">MANPREET</span>
        <span>&copy; {new Date().getFullYear()} // v2.0.4-stable</span>
      </div>
      <div class="flex gap-6">
        <a href="mailto:manpreet10542@gmail.com" class="hover:text-text-main transition-colors">EMAIL</a>
        <a href="https://linkedin.com/in/manpreet113" class="hover:text-text-main transition-colors">LINKEDIN</a>
        <a href="https://github.com/manpreet113" class="hover:text-text-main transition-colors">GITHUB</a>
      </div>
    </footer>

  </main>
</Layout>